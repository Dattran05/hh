import requests
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

TELEGRAM_TOKEN = '6774199178:AAHsZOOvRLpHV8IZCfXd5wuas3p0rCJOi8U'
COINMARKETCAP_API_KEY = '7d2eefad-868f-4dfa-81bc-7c83a7b0eab9'
COINMARKETCAP_URL = 'https://pro-api.coinmarketcap.com/v1/cryptocurrency/quotes/latest'
EXCHANGERATE_API_KEY = '53458279fed6023113cb8965'
EXCHANGERATE_URL = 'https://v6.exchangerate-api.com/v6/'

async def get_usd_to_vnd_rate():
    try:
        url = f'{EXCHANGERATE_URL}{EXCHANGERATE_API_KEY}/latest/USD'
        response = requests.get(url)
        data = response.json()
        if data['result'] == 'success':
            return data['conversion_rates']['VND']
        else:
            return 25000
    except Exception:
        return 25000

async def get_crypto_price(symbol: str):
    try:
        headers = {
            'X-CMC_PRO_API_KEY': COINMARKETCAP_API_KEY,
            'Accept': 'application/json'
        }
        params = {
            'symbol': symbol,
            'convert': 'USD'
        }
        response = requests.get(COINMARKETCAP_URL, headers=headers, params=params)
        data = response.json()
        if 'data' in data and symbol in data['data']:
            return data['data'][symbol]['quote']['USD']['price']
        return None
    except Exception:
        return None

async def delete_messages(context: ContextTypes.DEFAULT_TYPE, chat_id: int, user_message_id: int, bot_message_id: int):
    """HÃ m Ä‘á»ƒ xÃ³a cáº£ tin nháº¯n cá»§a ngÆ°á»i dÃ¹ng vÃ  tin nháº¯n cá»§a bot sau 3 phÃºt"""
    await asyncio.sleep(180)  # Chá» 3 phÃºt (180 giÃ¢y)
    try:
        await context.bot.delete_message(chat_id=chat_id, message_id=user_message_id)
        await context.bot.delete_message(chat_id=chat_id, message_id=bot_message_id)
    except Exception as e:
        print(f"KhÃ´ng thá»ƒ xÃ³a tin nháº¯n: {e}")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    message = await update.message.reply_text(
        'ðŸ‘‹ ChÃ o má»«ng Ä‘áº¿n vá»›i DatXcon Bot!\n'
        'ðŸ“Œ /p <symbol> - Kiá»ƒm tra giÃ¡\n'
        'ðŸ“Œ /val <sá»‘_lÆ°á»£ng> <symbol> - TÃ­nh giÃ¡ trá»‹\n'
        'ðŸ“Œ /apr <symbol> <sá»‘_lÆ°á»£ng> <apr> <ngÃ y> - TÃ­nh APR\n'
        'ðŸ“Œ /buy <sá»‘_lÆ°á»£ng> <symbol> <giÃ¡_mua_USD> - TÃ­nh lÃ£i/lá»— so vá»›i giÃ¡ hiá»‡n táº¡i\n'
        'ðŸ“Œ /sell <sá»‘_lÆ°á»£ng> <symbol> <giÃ¡_bÃ¡n_USD> - TÃ­nh lÃ£i/lá»— so vá»›i giÃ¡ hiá»‡n táº¡i\n'
        'ðŸ’¡ VÃ­ dá»¥: /p BTC, /val 2.5 BTC, /apr BTC 10 5 30, /buy 1 BTC 50000, /sell 1 BTC 55000'
    )
    asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

async def price(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if not context.args:
        message = await update.message.reply_text('âš ï¸ Vui lÃ²ng cung cáº¥p symbol token. VÃ­ dá»¥: /p BTC')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
        return

    symbol = context.args[0].upper()

    try:
        usd_to_vnd_rate = await get_usd_to_vnd_rate()
        headers = {
            'X-CMC_PRO_API_KEY': COINMARKETCAP_API_KEY,
            'Accept': 'application/json'
        }
        params = {
            'symbol': symbol,
            'convert': 'USD'
        }

        response = requests.get(COINMARKETCAP_URL, headers=headers, params=params)
        data = response.json()

        if 'data' not in data or symbol not in data['data']:
            message = await update.message.reply_text(f'âŒ KhÃ´ng tÃ¬m tháº¥y token {symbol}')
            asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
            return

        crypto_data = data['data'][symbol]
        price_usd = crypto_data['quote']['USD']['price']
        volume_24h_usd = crypto_data['quote']['USD']['volume_24h']
        percent_change_24h = crypto_data['quote']['USD']['percent_change_24h']

        price_vnd = price_usd * usd_to_vnd_rate

        message_text = (
            f'ðŸ“Š *ThÃ´ng tin {symbol}:*\n'
            f'ðŸ’° **GiÃ¡: ${price_usd:,.2f} | {price_vnd:,.0f} VND**\n'
            f'ðŸ“ˆ *Khá»‘i lÆ°á»£ng 24h:* ${volume_24h_usd:,.2f}\n'
            f'ðŸ“‰ *Thay Ä‘á»•i 24h:* {percent_change_24h:.2f}% '
            f'{"ðŸ”º" if percent_change_24h > 0 else "ðŸ”»"}'
        )

        message = await update.message.reply_text(message_text, parse_mode='Markdown')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

    except Exception as e:
        message = await update.message.reply_text(f'âš ï¸ CÃ³ lá»—i xáº£y ra: {str(e)}')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

async def value(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if len(context.args) < 2:
        message = await update.message.reply_text('âš ï¸ Vui lÃ²ng cung cáº¥p sá»‘ lÆ°á»£ng vÃ  symbol. VÃ­ dá»¥: /val 2.5 BTC')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
        return

    try:
        amount = float(context.args[0])
        symbol = context.args[1].upper()

        usd_to_vnd_rate = await get_usd_to_vnd_rate()
        price_usd = await get_crypto_price(symbol)

        if price_usd is None:
            message = await update.message.reply_text(f'âŒ KhÃ´ng tÃ¬m tháº¥y token {symbol}')
            asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
            return

        value_usd = price_usd * amount
        value_vnd = value_usd * usd_to_vnd_rate

        message_text = (
            f'ðŸ“Š *GiÃ¡ trá»‹ {amount} {symbol}:*\n'
            f'ðŸ’° **${value_usd:,.2f} | {value_vnd:,.0f} VND**'
        )

        message = await update.message.reply_text(message_text, parse_mode='Markdown')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

    except ValueError:
        message = await update.message.reply_text('âš ï¸ Sá»‘ lÆ°á»£ng pháº£i lÃ  sá»‘. VÃ­ dá»¥: /val 2.5 BTC')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
    except Exception as e:
        message = await update.message.reply_text(f'âš ï¸ CÃ³ lá»—i xáº£y ra: {str(e)}')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

async def apr(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if len(context.args) < 4:
        message = await update.message.reply_text('âš ï¸ Vui lÃ²ng cung cáº¥p Ä‘áº§y Ä‘á»§: /apr <symbol> <sá»‘_lÆ°á»£ng> <apr> <ngÃ y>. VÃ­ dá»¥: /apr BTC 10 5 30')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
        return

    try:
        symbol = context.args[0].upper()
        amount = float(context.args[1])
        apr_percent = float(context.args[2])
        days = float(context.args[3])

        usd_to_vnd_rate = await get_usd_to_vnd_rate()
        price_usd = await get_crypto_price(symbol)

        if price_usd is None:
            message = await update.message.reply_text(f'âŒ KhÃ´ng tÃ¬m tháº¥y token {symbol}')
            asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
            return

        apr_daily = apr_percent / 365 / 100
        apr_hourly = apr_daily / 24

        token_per_hour = amount * apr_hourly
        token_per_day = amount * apr_daily
        token_total = amount * apr_daily * days

        vnd_per_hour = token_per_hour * price_usd * usd_to_vnd_rate
        vnd_per_day = token_per_day * price_usd * usd_to_vnd_rate
        vnd_total = token_total * price_usd * usd_to_vnd_rate

        message_text = (
            f'ðŸ“Š *APR cho {amount} {symbol}:*\n'
            f'ðŸ“ˆ *APR:* {apr_percent}%/nÄƒm\n'
            f'â³ *1 giá»:* {token_per_hour:.6f} {symbol} (~{vnd_per_hour:,.0f} VND)\n'
            f'ðŸŒž *24 giá»:* {token_per_day:.6f} {symbol} (~{vnd_per_day:,.0f} VND)\n'
            f'ðŸ“… *{days} ngÃ y:* {token_total:.6f} {symbol} (~{vnd_total:,.0f} VND)'
        )

        message = await update.message.reply_text(message_text, parse_mode='Markdown')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

    except ValueError:
        message = await update.message.reply_text('âš ï¸ CÃ¡c giÃ¡ trá»‹ pháº£i lÃ  sá»‘. VÃ­ dá»¥: /apr BTC 10 5 30')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
    except Exception as e:
        message = await update.message.reply_text(f'âš ï¸ CÃ³ lá»—i xáº£y ra: {str(e)}')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

async def buy(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if len(context.args) < 3:
        message = await update.message.reply_text('âš ï¸ Vui lÃ²ng cung cáº¥p sá»‘ lÆ°á»£ng, symbol vÃ  giÃ¡ mua (USD). VÃ­ dá»¥: /buy 1 BTC 50000')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
        return

    try:
        amount = float(context.args[0])
        symbol = context.args[1].upper()
        buy_price = float(context.args[2])  # GiÃ¡ mua do ngÆ°á»i dÃ¹ng nháº­p

        usd_to_vnd_rate = await get_usd_to_vnd_rate()
        current_price = await get_crypto_price(symbol)

        if current_price is None:
            message = await update.message.reply_text(f'âŒ KhÃ´ng tÃ¬m tháº¥y token {symbol}')
            asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
            return

        buy_total_usd = buy_price * amount
        current_total_usd = current_price * amount
        profit_usd = current_total_usd - buy_total_usd
        profit_vnd = profit_usd * usd_to_vnd_rate

        message_text = (
            f'ðŸ“ˆ *TÃ­nh lÃ£i/lá»— cho {amount} {symbol}:*\n'
            f'ðŸ’° GiÃ¡ mua: ${buy_price:,.2f}\n'
            f'ðŸ’° GiÃ¡ hiá»‡n táº¡i: ${current_price:,.2f} | {current_price * usd_to_vnd_rate:,.0f} VND\n'
            f'ðŸ“Š GiÃ¡ trá»‹ hiá»‡n táº¡i: ${current_total_usd:,.2f} | {current_total_usd * usd_to_vnd_rate:,.0f} VND\n'
            f'ðŸ“ˆ LÃ£i/Lá»—: ${profit_usd:,.2f} | {profit_vnd:,.0f} VND '
            f'{"(LÃ£i)" if profit_usd > 0 else "(Lá»—)" if profit_usd < 0 else "(HÃ²a vá»‘n)"}'
        )

        message = await update.message.reply_text(message_text, parse_mode='Markdown')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

    except ValueError:
        message = await update.message.reply_text('âš ï¸ Sá»‘ lÆ°á»£ng vÃ  giÃ¡ mua pháº£i lÃ  sá»‘. VÃ­ dá»¥: /buy 1 BTC 50000')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
    except Exception as e:
        message = await update.message.reply_text(f'âš ï¸ CÃ³ lá»—i xáº£y ra: {str(e)}')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

async def sell(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if len(context.args) < 3:
        message = await update.message.reply_text('âš ï¸ Vui lÃ²ng cung cáº¥p sá»‘ lÆ°á»£ng, symbol vÃ  giÃ¡ bÃ¡n (USD). VÃ­ dá»¥: /sell 1 BTC 55000')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
        return

    try:
        amount = float(context.args[0])
        symbol = context.args[1].upper()
        sell_price = float(context.args[2])  # GiÃ¡ bÃ¡n do ngÆ°á»i dÃ¹ng nháº­p

        usd_to_vnd_rate = await get_usd_to_vnd_rate()
        current_price = await get_crypto_price(symbol)

        if current_price is None:
            message = await update.message.reply_text(f'âŒ KhÃ´ng tÃ¬m tháº¥y token {symbol}')
            asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
            return

        sell_total_usd = sell_price * amount
        current_total_usd = current_price * amount
        profit_usd = sell_total_usd - current_total_usd
        profit_vnd = profit_usd * usd_to_vnd_rate

        message_text = (
            f'ðŸ“‰ *TÃ­nh lÃ£i/lá»— cho {amount} {symbol}:*\n'
            f'ðŸ’° GiÃ¡ bÃ¡n: ${sell_price:,.2f}\n'
            f'ðŸ’° GiÃ¡ hiá»‡n táº¡i: ${current_price:,.2f} | {current_price * usd_to_vnd_rate:,.0f} VND\n'
            f'ðŸ“Š GiÃ¡ trá»‹ hiá»‡n táº¡i: ${current_total_usd:,.2f} | {current_total_usd * usd_to_vnd_rate:,.0f} VND\n'
            f'ðŸ“ˆ LÃ£i/Lá»—: ${profit_usd:,.2f} | {profit_vnd:,.0f} VND '
            f'{"(LÃ£i)" if profit_usd > 0 else "(Lá»—)" if profit_usd < 0 else "(HÃ²a vá»‘n)"}'
        )

        message = await update.message.reply_text(message_text, parse_mode='Markdown')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

    except ValueError:
        message = await update.message.reply_text('âš ï¸ Sá»‘ lÆ°á»£ng vÃ  giÃ¡ bÃ¡n pháº£i lÃ  sá»‘. VÃ­ dá»¥: /sell 1 BTC 55000')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))
    except Exception as e:
        message = await update.message.reply_text(f'âš ï¸ CÃ³ lá»—i xáº£y ra: {str(e)}')
        asyncio.create_task(delete_messages(context, update.message.chat_id, update.message.message_id, message.message_id))

def main() -> None:
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("p", price))
    application.add_handler(CommandHandler("val", value))
    application.add_handler(CommandHandler("apr", apr))
    application.add_handler(CommandHandler("buy", buy))
    application.add_handler(CommandHandler("sell", sell))
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
    from flask import Flask
    from threading import Thread

    app = Flask(__name__)

    @app.route('/')
    def home():
        return "Bot is running!"

    def run():
        app.run(host='0.0.0.0', port=8080)

    t = Thread(target=run)
    t.start()
